<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="unnamed.ico">
    <title>Student Life OS - Planer Tygodniowy</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #f9fafb; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Ukrywanie spinnerów w inputach number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- DEFINICJE IKON ---
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Smartphone = (p) => <IconBase {...p}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></IconBase>;
        const BookOpen = (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Music = (p) => <IconBase {...p}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></IconBase>;
        const Dumbbell = (p) => <IconBase {...p}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></IconBase>;
        const GraduationCap = (p) => <IconBase {...p}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></IconBase>;
        const CalendarIcon = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const Layout = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const FileSpreadsheet = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>;
        const ChevronLeft = (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const BarChart3 = (p) => <IconBase {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const PieChart = (p) => <IconBase {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Target = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>;
        const Clock = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const CalendarDays = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></IconBase>;

        const IconWrapper = ({ icon, ...props }) => {
            if (!icon) return null;
            return React.cloneElement(icon, { ...props });
        };

        // --- KONFIGURACJA ---
        const hours = Array.from({ length: 16 }, (_, i) => i + 7);

        // Dodajemy kolory dla wykresu
        const defaultActivities = [
            { id: 'uni', name: 'Nauka własna', icon: <GraduationCap size={16} />, category: 'Obowiązki', color: '#3b82f6' }, // blue
            { id: 'eng', name: 'Język Angielski', icon: <BookOpen size={16} />, category: 'Rozwój', color: '#8b5cf6' }, // violet
            { id: 'book', name: 'Czytanie Książek', icon: <BookOpen size={16} />, category: 'Rozwój', color: '#a855f7' }, // purple
            { id: 'piano', name: 'Gra na Pianinie', icon: <Music size={16} />, category: 'Muzyka', color: '#ec4899' }, // pink
            { id: 'guitar', name: 'Gra na Gitarze', icon: <Music size={16} />, category: 'Muzyka', color: '#f43f5e' }, // rose
            { id: 'gym', name: 'Trening / Siłownia', icon: <Dumbbell size={16} />, category: 'Zdrowie', color: '#10b981' }, // emerald
        ];

        const PhoneActivity = { id: 'phone', name: 'Czas na Telefonie', icon: <Smartphone size={16} />, category: 'Strata', color: '#ef4444' }; // red

        // --- FUNKCJE POMOCNICZE CZASU ---
        const toMinutes = (h, m) => (parseInt(h) || 0) * 60 + (parseInt(m) || 0);
        const fromMinutes = (totalMinutes) => {
            const h = Math.floor((totalMinutes || 0) / 60);
            const m = (totalMinutes || 0) % 60;
            return { h, m };
        };
        const formatDuration = (totalMinutes) => {
            const { h, m } = fromMinutes(totalMinutes);
            if (h === 0 && m === 0) return "0m";
            return `${h}h ${m}m`;
        };

        // --- KOMPONENT INPUTA CZASU ---
        const DurationInput = ({ value, onChange, placeholder, isBad }) => {
            const { h, m } = fromMinutes(value);
            
            const handleH = (e) => {
                const newH = Math.max(0, parseInt(e.target.value) || 0);
                onChange(newH * 60 + m);
            };
            
            const handleM = (e) => {
                const newM = Math.max(0, Math.min(59, parseInt(e.target.value) || 0));
                onChange(h * 60 + newM);
            };

            const bgClass = isBad ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200 focus-within:border-blue-400 focus-within:ring-1 focus-within:ring-blue-200';

            return (
                <div className={`flex items-center border rounded-md px-1 py-0.5 ${bgClass} w-24 mx-auto`}>
                    <input 
                        type="number" 
                        min="0"
                        className="w-8 text-right text-xs bg-transparent outline-none p-0.5 font-medium text-gray-700"
                        value={h || ''} 
                        onChange={handleH} 
                        placeholder="0"
                    />
                    <span className="text-gray-400 text-xs px-0.5">h</span>
                    <input 
                        type="number" 
                        min="0" 
                        max="59"
                        className="w-8 text-right text-xs bg-transparent outline-none p-0.5 font-medium text-gray-700"
                        value={m || ''} 
                        onChange={handleM} 
                        placeholder="0"
                    />
                    <span className="text-gray-400 text-xs px-0.5">m</span>
                </div>
            );
        };

        // --- KOMPONENT WYKRESU KOŁOWEGO (CSS CONIC GRADIENT) ---
        const SimplePieChart = ({ data }) => {
            const total = data.reduce((acc, item) => acc + item.value, 0);
            
            if (total === 0) return (
                <div className="flex flex-col items-center justify-center h-40 text-gray-400 text-xs">
                    <div className="w-24 h-24 rounded-full border-4 border-gray-100 mb-2"></div>
                    Brak danych
                </div>
            );

            let currentAngle = 0;
            const gradientParts = data.map(item => {
                const percentage = (item.value / total) * 100;
                const start = currentAngle;
                const end = currentAngle + percentage;
                currentAngle = end;
                return `${item.color} ${start}% ${end}%`;
            });

            return (
                <div className="flex flex-col sm:flex-row items-center gap-6 justify-center">
                    <div 
                        className="w-32 h-32 rounded-full border-4 border-white shadow-md shrink-0"
                        style={{ background: `conic-gradient(${gradientParts.join(', ')})` }}
                    />
                    <div className="space-y-1.5 w-full max-w-xs">
                        {data.map(item => (
                            <div key={item.label} className="flex items-center justify-between text-xs">
                                <div className="flex items-center gap-2">
                                    <span className="w-2.5 h-2.5 rounded-full" style={{ background: item.color }}></span>
                                    <span className="text-gray-700 font-medium">{item.label}</span>
                                </div>
                                <div className="text-gray-500">
                                    {formatDuration(item.value)} <span className="text-gray-300 ml-1">({Math.round(item.value / total * 100)}%)</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- FUNKCJE DATY ---
        const toLocalISOString = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getMonday = (d) => {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); 
            date.setDate(diff);
            date.setHours(0, 0, 0, 0);
            return date;
        };

        const formatDate = (date) => date.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' });
        const getMonthName = (date) => date.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
        const addDays = (date, days) => {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        };

        // --- GŁÓWNY KOMPONENT ---
        function WeeklyPlanner() {
            const [activeTab, setActiveTab] = useState('tracker'); 
            const [currentWeekStart, setCurrentWeekStart] = useState(getMonday(new Date()));
            const [debugInfo, setDebugInfo] = useState(null);
            const [showGoalModal, setShowGoalModal] = useState(false);
            const fileInputRef = useRef(null);

            const currentDays = Array.from({ length: 7 }, (_, i) => {
                const d = addDays(currentWeekStart, i);
                return {
                    dateObj: d,
                    dateStr: formatDate(d),
                    dayKey: ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][d.getDay()],
                    label: d.toLocaleDateString('pl-PL', { weekday: 'long' }),
                    short: d.toLocaleDateString('pl-PL', { weekday: 'short' }),
                    iso: toLocalISOString(d)
                };
            });

            // --- STAN DANYCH ---
            const [trackerData, setTrackerData] = useState(() => {
                const saved = localStorage.getItem('plannerData_v3');
                return saved ? JSON.parse(saved) : {};
            });

            const [goalsConfig, setGoalsConfig] = useState(() => {
                const saved = localStorage.getItem('plannerGoals');
                const defaults = {};
                [PhoneActivity, ...defaultActivities].forEach(act => defaults[act.id] = 0);
                return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
            });

            const [allEvents, setAllEvents] = useState(() => {
                const saved = localStorage.getItem('allEvents_v2');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => { localStorage.setItem('plannerData_v3', JSON.stringify(trackerData)); }, [trackerData]);
            useEffect(() => { localStorage.setItem('plannerGoals', JSON.stringify(goalsConfig)); }, [goalsConfig]);
            useEffect(() => { localStorage.setItem('allEvents_v2', JSON.stringify(allEvents)); }, [allEvents]);

            // --- OBSŁUGA TRACKERA ---
            const updateTracker = (activityId, dayIso, value) => {
                setTrackerData(prev => ({ ...prev, [`${dayIso}_${activityId}`]: value }));
            };

            const getTrackerValue = (activityId, dayIso) => {
                return trackerData[`${dayIso}_${activityId}`] || 0;
            };

            const updateGoal = (activityId, minutes) => {
                setGoalsConfig(prev => ({ ...prev, [activityId]: minutes }));
            };

            // --- KALKULACJE ---
            const calculateWeeklyTotal = (activityId) => {
                let sum = 0;
                currentDays.forEach(day => {
                    sum += getTrackerValue(activityId, day.iso);
                });
                return sum;
            };

            // Nowe funkcje kalkulacji dla raportów
            const calculateMonthlyTotal = (activityId, currentMonthDate) => {
                let sum = 0;
                const targetMonth = currentMonthDate.getMonth();
                const targetYear = currentMonthDate.getFullYear();

                Object.keys(trackerData).forEach(key => {
                    const [dateStr, actId] = key.split('_');
                    if (actId === activityId) {
                        const date = new Date(dateStr);
                        if (date.getMonth() === targetMonth && date.getFullYear() === targetYear) {
                            sum += (trackerData[key] || 0);
                        }
                    }
                });
                return sum;
            };

            const calculateAllTimeTotal = (activityId) => {
                let sum = 0;
                Object.keys(trackerData).forEach(key => {
                    const [_, actId] = key.split('_');
                    if (actId === activityId) {
                        sum += (trackerData[key] || 0);
                    }
                });
                return sum;
            };

            // --- EKSPORT CSV ---
            const exportToCSV = () => {
                const SEP = ';';
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += `CELE TYGODNIOWE (h:m)${SEP}${SEP}\n`;
                [PhoneActivity, ...defaultActivities].forEach(act => csvContent += `${act.name}${SEP}${formatDuration(goalsConfig[act.id])}\n`);
                csvContent += `\nRAPORT SZCZEGÓŁOWY (Minuty)${SEP}${SEP}${SEP}\n`;
                csvContent += `Data${SEP}Kategoria${SEP}Aktywność${SEP}Czas (min)\n`;
                const sortedKeys = Object.keys(trackerData).sort();
                sortedKeys.forEach(key => {
                    const [dateStr, actId] = key.split('_');
                    const val = trackerData[key];
                    if (val > 0) {
                        let actName = defaultActivities.find(a => a.id === actId)?.name || PhoneActivity.name;
                        csvContent += `${dateStr}${SEP}Realizacja${SEP}${actName}${SEP}${val}\n`;
                    }
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "student_planner_export.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- OBSŁUGA PLIKÓW ICS ---
            const parseICSContent = (content) => {
                const rawLines = content.split(/\r\n|\n|\r/);
                const unfoldedLines = [];
                rawLines.forEach(line => {
                    if (line.startsWith(' ') || line.startsWith('\t')) {
                        if (unfoldedLines.length > 0) unfoldedLines[unfoldedLines.length - 1] += line.trimStart();
                    } else if (line.trim()) unfoldedLines.push(line.trim());
                });
                const events = [];
                let inEvent = false;
                let currentEvent = {};
                unfoldedLines.forEach(line => {
                    if (line === 'BEGIN:VEVENT') { inEvent = true; currentEvent = {}; }
                    else if (line === 'END:VEVENT') {
                        inEvent = false;
                        if (currentEvent.startRaw) {
                            if (!currentEvent.summary) currentEvent.summary = "Bez tytułu";
                            events.push({ ...currentEvent, id: Date.now() + Math.random() });
                        }
                    } else if (inEvent) {
                        const colonIndex = line.indexOf(':');
                        if (colonIndex > -1) {
                            let keyPart = line.substring(0, colonIndex);
                            const valuePart = line.substring(colonIndex + 1);
                            const semiIndex = keyPart.indexOf(';');
                            if (semiIndex > -1) keyPart = keyPart.substring(0, semiIndex);
                            keyPart = keyPart.toUpperCase();
                            if (keyPart === 'DTSTART') currentEvent.startRaw = valuePart;
                            if (keyPart === 'DTEND') currentEvent.endRaw = valuePart;
                            if (keyPart === 'SUMMARY') currentEvent.summary = valuePart;
                        }
                    }
                });
                return events;
            };

            const parseICSDate = (dateStr) => {
                if (!dateStr) return null;
                const isUTC = dateStr.endsWith('Z');
                const cleanStr = dateStr.replace('Z', '');
                if (cleanStr.length === 8) {
                    const y = parseInt(cleanStr.substring(0, 4));
                    const m = parseInt(cleanStr.substring(4, 6)) - 1;
                    const d = parseInt(cleanStr.substring(6, 8));
                    return new Date(y, m, d, 8, 0);
                }
                if (cleanStr.length >= 15) {
                    const y = parseInt(cleanStr.substring(0, 4));
                    const m = parseInt(cleanStr.substring(4, 6)) - 1;
                    const d = parseInt(cleanStr.substring(6, 8));
                    const h = parseInt(cleanStr.substring(9, 11));
                    const min = parseInt(cleanStr.substring(11, 13));
                    return isUTC ? new Date(Date.UTC(y, m, d, h, min)) : new Date(y, m, d, h, min);
                }
                return null;
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                event.target.value = null;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const rawEvents = parseICSContent(content);
                        const parsedEvents = [];
                        rawEvents.forEach(evt => {
                            const startDate = parseICSDate(evt.startRaw);
                            const endDate = parseICSDate(evt.endRaw);
                            if (startDate) {
                                const duration = endDate ? (endDate - startDate) / (1000 * 60 * 60) : 1.5;
                                parsedEvents.push({
                                    id: evt.id, name: evt.summary, start: startDate.toISOString(),
                                    end: endDate ? endDate.toISOString() : null, duration: duration > 0 ? duration : 1
                                });
                            }
                        });
                        if (parsedEvents.length > 0) {
                            setAllEvents(prev => {
                                const newEvents = [...prev, ...parsedEvents];
                                return Array.from(new Map(newEvents.map(item => [item.start + item.name, item])).values());
                            });
                            alert(`Sukces! Dodano ${parsedEvents.length} wydarzeń.`);
                        } else { setDebugInfo("Nie znaleziono wydarzeń."); }
                    } catch (err) { setDebugInfo("Błąd: " + err.message); }
                };
                reader.readAsText(file);
            };

            const getEventsForDay = (dateIso) => {
                const [y, m, d] = dateIso.split('-').map(Number);
                const dayStart = new Date(y, m - 1, d, 0, 0, 0);
                const dayEnd = new Date(y, m - 1, d, 23, 59, 59);
                return allEvents.filter(evt => {
                    const evtStart = new Date(evt.start);
                    return evtStart >= dayStart && evtStart <= dayEnd;
                }).map(evt => ({ ...evt, startHour: new Date(evt.start).getHours(), startMin: new Date(evt.start).getMinutes() }));
            };

            // --- RENDER ---
            return (
                <div className="max-w-screen-2xl mx-auto p-2 sm:p-4 font-sans text-gray-800">
                    {/* NAVBAR */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 mb-4 p-4 sticky top-0 z-20">
                        <div className="flex flex-col xl:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4">
                                <div className="flex items-center bg-gray-100 rounded-lg p-1">
                                    <button onClick={() => setCurrentWeekStart(prev => addDays(prev, -7))} className="p-2 hover:bg-white rounded-md transition-colors"><IconWrapper icon={<ChevronLeft size={20}/>}/></button>
                                    <button onClick={() => setCurrentWeekStart(getMonday(new Date()))} className="px-4 py-2 text-sm font-bold text-gray-700 hover:text-blue-600">Dzisiaj</button>
                                    <button onClick={() => setCurrentWeekStart(prev => addDays(prev, 7))} className="p-2 hover:bg-white rounded-md transition-colors"><IconWrapper icon={<ChevronRight size={20}/>}/></button>
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold text-gray-800">{currentWeekStart.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' })}</h2>
                                    <p className="text-xs text-gray-500">Tydzień: {formatDate(currentWeekStart)} - {formatDate(addDays(currentWeekStart, 6))}</p>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-2 items-center justify-center">
                                <div className="flex gap-2 bg-gray-100 p-1 rounded-lg">
                                    <button onClick={() => setActiveTab('tracker')} className={`px-3 py-2 rounded-md text-sm font-bold flex gap-2 ${activeTab === 'tracker' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'}`}><IconWrapper icon={<Layout size={16}/>}/> Nawyki</button>
                                    <button onClick={() => setActiveTab('schedule')} className={`px-3 py-2 rounded-md text-sm font-bold flex gap-2 ${activeTab === 'schedule' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'}`}><IconWrapper icon={<CalendarIcon size={16}/>}/> Kalendarz</button>
                                    <button onClick={() => setActiveTab('summary')} className={`px-3 py-2 rounded-md text-sm font-bold flex gap-2 ${activeTab === 'summary' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'}`}><IconWrapper icon={<BarChart3 size={16}/>}/> Raporty</button>
                                </div>
                                <button onClick={() => setShowGoalModal(true)} className="ml-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors shadow-sm"><IconWrapper icon={<Target size={18}/>}/> <span className="hidden sm:inline">Ustaw Cele</span></button>
                                <button onClick={exportToCSV} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors shadow-sm" title="Pobierz plik CSV"><IconWrapper icon={<Download size={18}/>}/></button>
                            </div>
                        </div>
                    </div>

                    {/* MODAL CELÓW */}
                    {showGoalModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                    <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><IconWrapper icon={<Target size={20}/>}/> Skonfiguruj Cele Tygodniowe</h3>
                                    <button onClick={() => setShowGoalModal(false)} className="text-gray-400 hover:text-gray-600"><IconWrapper icon={<X size={20}/>}/></button>
                                </div>
                                <div className="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                                    <div className="p-3 bg-blue-50 text-blue-800 text-sm rounded-lg mb-4">Tutaj ustalasz, ile czasu <strong>tygodniowo</strong> chcesz poświęcić na każdą czynność.</div>
                                    <div className="flex items-center justify-between p-3 bg-red-50 border border-red-100 rounded-lg">
                                        <div className="flex items-center gap-3"><div className="p-2 bg-white rounded-full text-red-600 shadow-sm"><IconWrapper icon={PhoneActivity.icon}/></div><div><div className="font-bold text-gray-800">{PhoneActivity.name}</div><div className="text-xs text-red-600">Limit tygodniowy (max)</div></div></div>
                                        <DurationInput value={goalsConfig[PhoneActivity.id]} onChange={(val) => updateGoal(PhoneActivity.id, val)} />
                                    </div>
                                    {defaultActivities.map(act => (
                                        <div key={act.id} className="flex items-center justify-between p-2 border-b border-gray-100 last:border-0">
                                            <div className="flex items-center gap-3"><div className="text-gray-500"><IconWrapper icon={act.icon} size={20}/></div><div className="font-medium text-gray-700">{act.name}</div></div>
                                            <DurationInput value={goalsConfig[act.id]} onChange={(val) => updateGoal(act.id, val)} />
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 border-t bg-gray-50 text-right"><button onClick={() => setShowGoalModal(false)} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold">Zapisz i Zamknij</button></div>
                            </div>
                        </div>
                    )}

                    {debugInfo && <div className="bg-red-50 text-red-700 p-4 rounded-xl border border-red-200 mb-4 flex items-start gap-3"><IconWrapper icon={<AlertTriangle size={20} className="mt-0.5 shrink-0"/>}/><div><p className="font-bold">Błąd</p><p className="text-sm">{debugInfo}</p></div></div>}

                    {/* WIDOK: TRACKER */}
                    {activeTab === 'tracker' && (
                        <div className="animate-fade-in bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                            <div className="p-4 bg-gray-50 border-b border-gray-200">
                                <h3 className="font-bold text-gray-700 flex items-center gap-2"><IconWrapper icon={<Clock size={20}/>}/> Rejestr Czasu - Wpisz ile czasu poświęciłeś</h3>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm min-w-[800px]">
                                    <thead>
                                        <tr className="bg-gray-100 text-xs text-gray-500 uppercase">
                                            <th className="p-3 text-left w-64 sticky left-0 bg-gray-100 z-10 border-r">Aktywność / Cel Tygodnia</th>
                                            {currentDays.map(day => <th key={day.iso} className="p-2 text-center border-r last:border-r-0 min-w-[110px]"><div className="font-bold text-gray-700">{day.short}</div><div className="text-[10px] text-gray-400">{day.dateStr}</div></th>)}
                                            <th className="p-3 text-center w-24 bg-gray-100 border-l font-bold">Suma</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        <tr className="bg-red-50/30 hover:bg-red-50/50 transition-colors">
                                            <td className="p-3 sticky left-0 bg-white z-10 border-r border-red-100 shadow-sm">
                                                <div className="flex items-center gap-2 font-bold text-red-800 mb-1"><IconWrapper icon={PhoneActivity.icon} size={18}/> {PhoneActivity.name}</div>
                                                <div className="text-xs text-red-500 flex justify-between items-center pr-2"><span>Limit: {formatDuration(goalsConfig[PhoneActivity.id])}</span></div>
                                            </td>
                                            {currentDays.map(day => <td key={day.iso} className="p-2 border-r border-red-50 last:border-r-0 text-center"><DurationInput value={getTrackerValue(PhoneActivity.id, day.iso)} onChange={(val) => updateTracker(PhoneActivity.id, day.iso, val)}/></td>)}
                                            <td className="p-3 text-center font-bold text-red-700 border-l border-red-100 bg-red-50/20">{(() => { const total = calculateWeeklyTotal(PhoneActivity.id); const goal = goalsConfig[PhoneActivity.id]; const isOver = total > goal && goal > 0; return <span className={isOver ? "text-red-600 bg-red-100 px-2 py-1 rounded" : ""}>{formatDuration(total)}</span> })()}</td>
                                        </tr>
                                        {defaultActivities.map(act => {
                                            const total = calculateWeeklyTotal(act.id);
                                            const goal = goalsConfig[act.id];
                                            const percent = goal > 0 ? Math.min(100, (total / goal) * 100) : 0;
                                            return (
                                                <tr key={act.id} className="hover:bg-gray-50 transition-colors group">
                                                    <td className="p-3 sticky left-0 bg-white z-10 border-r shadow-sm group-hover:bg-gray-50 transition-colors">
                                                        <div className="flex items-center gap-2 font-medium text-gray-700 mb-1"><IconWrapper icon={act.icon} size={18}/> {act.name}</div>
                                                        <div className="w-full bg-gray-200 rounded-full h-1.5 mt-1 overflow-hidden"><div className="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style={{ width: `${percent}%` }}></div></div>
                                                        <div className="text-[10px] text-gray-400 mt-1 flex justify-between"><span>Cel: {formatDuration(goal)}</span><span className={percent >= 100 ? "text-green-600 font-bold" : ""}>{Math.round(percent)}%</span></div>
                                                    </td>
                                                    {currentDays.map(day => <td key={day.iso} className="p-2 border-r border-dashed last:border-r-0 text-center"><DurationInput value={getTrackerValue(act.id, day.iso)} onChange={(val) => updateTracker(act.id, day.iso, val)}/></td>)}
                                                    <td className="p-3 text-center font-bold text-gray-700 border-l bg-gray-50/50"><span className={percent >= 100 ? "text-green-600" : ""}>{formatDuration(total)}</span></td>
                                                </tr>
                                            )
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* WIDOK: KALENDARZ */}
                    {activeTab === 'schedule' && (
                        <div className="animate-fade-in space-y-4">
                            <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl flex flex-col sm:flex-row justify-between items-center gap-4">
                                <div className="text-sm text-blue-800"><p className="font-bold">Import z USOS:</p><p>Wgraj plik .ics, aby zobaczyć swoje zajęcia.</p></div>
                                <div className="flex gap-2">
                                    <input type="file" accept=".ics" ref={fileInputRef} className="hidden" onChange={handleFileUpload} />
                                    <button onClick={() => fileInputRef.current.click()} className="bg-white text-blue-600 px-4 py-2 rounded-lg text-xs font-bold shadow-sm border border-blue-200 flex items-center gap-2 hover:bg-blue-50"><IconWrapper icon={<Upload size={14}/>}/> Wgraj ICS</button>
                                    {allEvents.length > 0 && <button onClick={() => confirm("Usunąć wszystko?") && setAllEvents([])} className="bg-white text-red-600 px-4 py-2 rounded-lg text-xs font-bold shadow-sm border border-red-200 flex items-center gap-2 hover:bg-red-50"><IconWrapper icon={<Trash2 size={14}/>}/> Wyczyść</button>}
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-7 gap-3">
                                {currentDays.map(day => {
                                    const events = getEventsForDay(day.iso);
                                    const busyHours = events.reduce((acc, curr) => acc + curr.duration, 0);
                                    return (
                                        <div key={day.iso} className={`bg-white rounded-xl shadow-sm border ${day.dateObj.toDateString() === new Date().toDateString() ? 'border-blue-400 ring-2 ring-blue-100' : 'border-gray-200'} flex flex-col h-full min-h-[300px]`}>
                                            <div className="p-3 border-b border-gray-100 text-center bg-gray-50/50 rounded-t-xl"><div className="text-sm font-bold text-gray-700">{day.label}</div><div className="text-xs text-gray-400">{day.dateStr}</div></div>
                                            <div className="flex-grow p-1 relative">
                                                {hours.map(h => <div key={h} className="h-10 border-b border-gray-50 text-[10px] text-gray-300 pl-1">{h}:00</div>)}
                                                {events.map(evt => {
                                                    const topPos = (evt.startHour - 7) * 40 + (evt.startMin / 60 * 40);
                                                    const height = Math.max(evt.duration * 40, 20);
                                                    return (
                                                        <div key={evt.id} className="absolute left-1 right-1 bg-blue-100 border-l-4 border-blue-600 rounded p-1 text-xs shadow-sm overflow-hidden z-10 hover:z-20 hover:scale-[1.02] transition-transform" style={{ top: `${topPos}px`, height: `${height}px` }} title={evt.name}>
                                                            <div className="font-bold text-blue-900 leading-tight truncate">{evt.name}</div>
                                                            <div className="text-[10px] text-blue-700 mt-0.5">{evt.startHour}:{evt.startMin < 10 ? '0'+evt.startMin : evt.startMin}</div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            <div className="p-2 text-center text-xs text-gray-500 bg-gray-50 rounded-b-xl">Zajęcia: {busyHours.toFixed(1)}h</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* WIDOK: RAPORTY (TYGODNIOWE, MIESIĘCZNE, CAŁOŚCIOWE) */}
                    {activeTab === 'summary' && (
                        <div className="animate-fade-in grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* 1. TYGODNIOWE */}
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><IconWrapper icon={<TrendingUp size={20} className="text-blue-600"/>}/> Obecny Tydzień</h3>
                                <p className="text-xs text-gray-400 mb-4">{formatDate(currentWeekStart)} - {formatDate(addDays(currentWeekStart, 6))}</p>
                                <div className="space-y-6">
                                    {[PhoneActivity, ...defaultActivities].map(act => {
                                        const total = calculateWeeklyTotal(act.id);
                                        const goal = goalsConfig[act.id];
                                        if (goal === 0 && total === 0) return null;
                                        const isPhone = act.id === 'phone';
                                        const percent = goal > 0 ? (total / goal) * 100 : 0;
                                        let barColor = isPhone ? (total > goal ? "bg-red-500" : "bg-green-500") : (percent >= 100 ? "bg-green-500" : "bg-blue-500");
                                        return (
                                            <div key={act.id}>
                                                <div className="flex justify-between text-sm mb-1 font-medium">
                                                    <span className="flex items-center gap-2"><IconWrapper icon={act.icon} size={16}/> {act.name}</span>
                                                    <span>{formatDuration(total)} <span className="text-gray-400">/ {formatDuration(goal)}</span></span>
                                                </div>
                                                <div className="w-full bg-gray-100 rounded-full h-2">
                                                    <div className={`h-2 rounded-full ${barColor} transition-all duration-700`} style={{ width: `${Math.min(100, percent)}%` }}></div>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>

                            {/* 2. MIESIĘCZNE */}
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><IconWrapper icon={<CalendarDays size={20} className="text-purple-600"/>}/> Miesiąc: {getMonthName(currentWeekStart)}</h3>
                                <p className="text-xs text-gray-400 mb-4">Suma godzin w tym miesiącu</p>
                                <div className="space-y-4">
                                    {[PhoneActivity, ...defaultActivities].map(act => {
                                        const monthlyTotal = calculateMonthlyTotal(act.id, currentWeekStart);
                                        if (monthlyTotal === 0) return null;
                                        return (
                                            <div key={act.id} className="flex justify-between items-center text-sm border-b border-gray-50 pb-2">
                                                <span className="flex items-center gap-2 text-gray-600"><IconWrapper icon={act.icon} size={16}/> {act.name}</span>
                                                <span className="font-bold text-gray-800">{formatDuration(monthlyTotal)}</span>
                                            </div>
                                        )
                                    })}
                                    {/* Jeśli brak danych */}
                                    {[PhoneActivity, ...defaultActivities].every(a => calculateMonthlyTotal(a.id, currentWeekStart) === 0) && 
                                        <div className="text-center text-gray-400 text-sm py-4">Brak danych w tym miesiącu</div>
                                    }
                                </div>
                            </div>

                            {/* 3. CAŁOŚCIOWE (PIE CHART) */}
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><IconWrapper icon={<PieChart size={20} className="text-orange-600"/>}/> Całościowe (All Time)</h3>
                                <div className="flex flex-col items-center">
                                    {(() => {
                                        // Przygotowanie danych do wykresu (bez telefonu, bo to strata czasu, zazwyczaj nie chcemy tego na wykresie "produktywności", ale user chciał "na co poświęcam czas", więc dajemy wszystko)
                                        // Opcjonalnie można wyrzucić telefon z wykresu kołowego, jeśli ma on pokazywać tylko "dobre" rzeczy. 
                                        // Tutaj damy wszystko oprócz telefonu do "produktywności", a telefon osobno, lub wszystko razem. Dajmy wszystko.
                                        const chartData = [PhoneActivity, ...defaultActivities].map(act => ({
                                            label: act.name,
                                            value: calculateAllTimeTotal(act.id),
                                            color: act.color || '#ccc'
                                        })).filter(d => d.value > 0).sort((a, b) => b.value - a.value);

                                        return <SimplePieChart data={chartData} />
                                    })()}
                                </div>
                                <div className="mt-6 pt-4 border-t border-gray-100 text-center">
                                    <div className="text-xs text-gray-500 uppercase tracking-wide">Łączny czas w aplikacji</div>
                                    <div className="text-2xl font-black text-gray-800">
                                        {formatDuration([PhoneActivity, ...defaultActivities].reduce((acc, act) => acc + calculateAllTimeTotal(act.id), 0))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WeeklyPlanner />);
    </script>
</body>
</html>